version: '3.6'

  # http://a.davidg.ml:46272
  # http://c.davidg.ml:46272/_utils/
  # http://couch429c.david462.tk:46272/_utils/
  # http://listo429c.david462.tk:46272/
  
# https://docs.docker.com/compose/compose-file/#external-1   
networks:
  sister:
    name: sister
      external:true      

services:

  couchdb:
    image: couchdb
    volumes:
          - ../data/home429c/:/home                  # folder for exported data, etc.
          - ../datasys/couch429c/:/opt/couchdb/data     #TODO set this
          - ./docker/couchdb/:/opt/couchdb/etc/local.d             
    ports:
        -   "6212:5984" # no ssl
    env_file:
      - .env      
    networks:
      - sister
    labels:
      - "virtual.host=couch.davidg.ml"
      - "virtual.port=5984"
      - "virtual.tls-email=dgleba@gmail.com" # set to valid email to activate SSL

  listo429c:
    # https://github.com/mikechernev/dockerised-php/blob/master/docker-compose.yml
    image:  nginx:1.14 
    # build:
      # context: ./
      # dockerfile: Dockerfile
    volumes:
        # - .:/usr/share/nginx/html
        - .:/usr/share/nginx/html
        # - ./docker/listo/site.conf:/etc/nginx/conf.d/default.conf
    ports:
        # -   "82:80"
        -   "6211:80"
    # links:
        # - "couchdb:couchdb"
    networks:
      - sister
    # environment:
      # VIRTUAL_HOST: listo429c.david462.tk      
      # VIRTUAL_HOST: a.davidg.ml      
      # VIRTUAL_PORT: 80      
    labels:
      - "virtual.host=l.davidg.ml"
      - "virtual.port=80"
      - "virtual.tls-email=dgleba@gmail.com" # set to valid email to activate SSL

  caddy-gen:
    container_name: caddy-gen
    # build: .
    build:
      context: ./caddy-gen
      dockerfile: Dockerfile
    restart: always
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./caddy-gen/certs/acme:/etc/caddy/acme  # to save acme
      - ./caddy-gen/certs/ocsp:/etc/caddy/ocsp  # to save certificates
      - ./caddy-gen/backup:/root/.caddy
      - ./caddy-gen:/crib
      - ./caddy-gen/backup:/root/.caddy
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      # - whoami
      - listo429c
      - couchdb
    networks:
      - sister

  # proxy1port:
    # image: nginx:1.14   
    # ports:
      # - "82:82"
    # volumes:
      # - ./docker/nginxproxy/upstream1port.conf:/etc/nginx/nginx.conf
    # networks:
      # - sister
    # depends_on:
      # - listo429c
      # - couchdb
      

  # proxy:
    # image: nginx:1.14   
    # ports:
      # - "83:83"
    # volumes:
      # # - ./app:/usr/share/nginx/html
      # - ./docker/nginxproxy/main.conf:/etc/nginx/nginx.conf
      # # - ./docker/nginxproxy/site.conf:/etc/nginx/conf.d/default.conf
    # networks:
      # - sister
    # depends_on:
      # - listo429c
      # - couchdb

  # # works.
  # proxy-upstream:
    # image: nginx:1.14   
    # ports:
      # - "84:84"
      # - "85:85"
    # volumes:
      # - ./docker/nginxproxy/upstream.conf:/etc/nginx/nginx.conf
    # networks:
      # - sister
    # depends_on:
      # - listo429c
      # - couchdb

  # works ok.   #  listo429c.david462.tk:46272  #  couchdb.david462.tk:46272
  #
  # nginx-proxy:
  #   image: jwilder/nginx-proxy
  #   ports:
  #     - "82:80"
  #   volumes:
  #     - /var/run/docker.sock:/tmp/docker.sock:ro
  #   networks:
  #     - sister


